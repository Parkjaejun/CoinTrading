# gui/main_window.py
"""
OKX ìë™ë§¤ë§¤ ì‹œìŠ¤í…œ - ê°„ì†Œí™”ëœ ë©”ì¸ ìœˆë„ìš°

êµ¬ì¡°:
- ìƒë‹¨ ë°”: ì”ê³ , BTC ê°€ê²©, ì—°ê²° ìƒíƒœ
- 2ê°œ íƒ­: ëŒ€ì‹œë³´ë“œ, ìë™ë§¤ë§¤
- ëŒ€ì‹œë³´ë“œ: ì‹¤ì‹œê°„ ì°¨íŠ¸ + í¬ì§€ì…˜ ì •ë³´
- ìë™ë§¤ë§¤: ì œì–´ + ì§„ì… í‰ê°€ + ë¡œê·¸

ë³€ê²½ ì‚¬í•­:
- ETH ë¹„í™œì„±í™” (BTCë§Œ ê±°ë˜/í‘œì‹œ)
- ì„¤ì • íƒ­ ì œê±° (ìë™ë§¤ë§¤ ìœ„ì ¯ ë‚´ í†µí•©)
- í¬ì§€ì…˜ íƒ­ ì œê±° (ëŒ€ì‹œë³´ë“œì— í†µí•©)
- ëª¨ë‹ˆí„°ë§/í…ŒìŠ¤íŠ¸/ë””ë²„ê¹… íƒ­ ì œê±°
"""

import sys
from datetime import datetime
from typing import Dict, Optional, Any

from PyQt5.QtWidgets import (
    QMainWindow, QWidget, QVBoxLayout, QHBoxLayout,
    QTabWidget, QLabel, QFrame, QGroupBox, QGridLayout,
    QTableWidget, QTableWidgetItem, QHeaderView,
    QMessageBox, QStatusBar, QSplitter, QPushButton
)
from PyQt5.QtCore import Qt, QTimer, pyqtSignal
from PyQt5.QtGui import QFont, QColor

# ë°±í…ŒìŠ¤íŠ¸ ìœ„ì ¯ import
try:
    import sys
    import os
    backtest_path = os.path.join(os.path.dirname(os.path.dirname(__file__)), 'backtest_project')
    if backtest_path not in sys.path:
        sys.path.insert(0, backtest_path)
    from main import create_backtest_tab
    BACKTEST_AVAILABLE = True
    print("âœ… ë°±í…ŒìŠ¤íŠ¸ ìœ„ì ¯ ë¡œë“œ ì„±ê³µ")
except ImportError as e:
    BACKTEST_AVAILABLE = False
    print(f"âš ï¸ ë°±í…ŒìŠ¤íŠ¸ ìœ„ì ¯ ë¡œë“œ ì‹¤íŒ¨: {e}")

# ì»´í¬ë„ŒíŠ¸ import
try:
    from gui.auto_trading_widget import AutoTradingWidget
    AUTO_TRADING_AVAILABLE = True
except ImportError:
    AUTO_TRADING_AVAILABLE = False
    print("âš ï¸ AutoTradingWidget ì‚¬ìš© ë¶ˆê°€")

try:
    from gui.widgets import PriceChartWidget
    CHART_AVAILABLE = True
except ImportError:
    try:
        from gui.price_chart_widget import PriceChartWidget
        CHART_AVAILABLE = True
    except ImportError:
        CHART_AVAILABLE = False
        print("âš ï¸ PriceChartWidget ì‚¬ìš© ë¶ˆê°€")

try:
    from gui.data_thread import TradingDataThread
    DATA_THREAD_AVAILABLE = True
except ImportError:
    DATA_THREAD_AVAILABLE = False
    print("âš ï¸ TradingDataThread ì‚¬ìš© ë¶ˆê°€")

try:
    from okx.account_manager import AccountManager
    ACCOUNT_MANAGER_AVAILABLE = True
except ImportError:
    ACCOUNT_MANAGER_AVAILABLE = False


# ë‹¤í¬ í…Œë§ˆ
DARK_THEME = """
    QMainWindow {
        background-color: #1e1e1e;
        color: #ffffff;
    }
    QWidget {
        background-color: #1e1e1e;
        color: #ffffff;
    }
    QTabWidget::pane {
        border: 1px solid #3a3a3a;
        background-color: #2b2b2b;
    }
    QTabBar::tab {
        background-color: #3a3a3a;
        color: #ffffff;
        padding: 10px 20px;
        margin-right: 2px;
        border-top-left-radius: 4px;
        border-top-right-radius: 4px;
        font-size: 13px;
    }
    QTabBar::tab:selected {
        background-color: #0078d4;
    }
    QGroupBox {
        font-weight: bold;
        border: 1px solid #3a3a3a;
        border-radius: 5px;
        margin-top: 10px;
        padding-top: 10px;
    }
    QGroupBox::title {
        subcontrol-origin: margin;
        left: 10px;
        padding: 0 5px;
    }
    QTableWidget {
        background-color: #2b2b2b;
        gridline-color: #3a3a3a;
        border: none;
    }
    QHeaderView::section {
        background-color: #3a3a3a;
        padding: 5px;
        border: none;
    }
    QPushButton {
        background-color: #0078d4;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
    }
    QPushButton:hover {
        background-color: #106ebe;
    }
    QPushButton:disabled {
        background-color: #555555;
        color: #888888;
    }
    QLabel {
        color: #ffffff;
    }
"""


class TradingMainWindow(QMainWindow):
    """ê°„ì†Œí™”ëœ ë©”ì¸ ìœˆë„ìš°"""
    
    # ì‹œê·¸ë„
    balance_updated = pyqtSignal(float)
    price_updated = pyqtSignal(str, float)
    
    def __init__(self):
        super().__init__()
        
        # ìƒíƒœ ë³€ìˆ˜
        self.current_balance = 0.0
        self.current_btc_price = 0.0
        self.is_connected = False
        self.positions = []
        
        # ê±°ë˜ ëŒ€ìƒ (BTCë§Œ)
        self.trading_symbol = 'BTC-USDT-SWAP'
        
        # UI ì„¤ì •
        self.setup_ui()
        self.setStyleSheet(DARK_THEME)
        
        # ë°ì´í„° ìŠ¤ë ˆë“œ ì‹œì‘
        self.setup_data_thread()
        
        # íƒ€ì´ë¨¸
        self.setup_timers()
    
    def setup_ui(self):
        """UI ì„¤ì •"""
        self.setWindowTitle("OKX ìë™ë§¤ë§¤ ì‹œìŠ¤í…œ v2")
        self.setGeometry(100, 100, 1400, 900)
        self.setMinimumSize(1200, 700)
        
        # ì¤‘ì•™ ìœ„ì ¯
        central_widget = QWidget()
        self.setCentralWidget(central_widget)
        
        main_layout = QVBoxLayout(central_widget)
        main_layout.setSpacing(5)
        main_layout.setContentsMargins(10, 10, 10, 10)
        
        # 1. ìƒë‹¨ ìƒíƒœë°”
        self.create_top_status_bar(main_layout)
        
        # 2. íƒ­ ìœ„ì ¯ (2ê°œë§Œ)
        self.tab_widget = QTabWidget()
        self.tab_widget.setFont(QFont("Arial", 11))
        
        # ëŒ€ì‹œë³´ë“œ íƒ­
        self.create_dashboard_tab()
        
        # ìë™ë§¤ë§¤ íƒ­
        self.create_auto_trading_tab()
        self.create_backtest_tab()  # ë°±í…ŒìŠ¤íŠ¸ íƒ­
        
        main_layout.addWidget(self.tab_widget)
        
        # í•˜ë‹¨ ìƒíƒœë°”
        self.status_bar = QStatusBar()
        self.setStatusBar(self.status_bar)
        self.status_bar.showMessage("ì‹œìŠ¤í…œ ì¤€ë¹„ ì™„ë£Œ")
    
    def create_top_status_bar(self, layout):
        """ìƒë‹¨ ìƒíƒœë°” - ì”ê³ , BTC ê°€ê²©, ì—°ê²° ìƒíƒœ"""
        status_frame = QFrame()
        status_frame.setFrameStyle(QFrame.StyledPanel)
        status_frame.setMaximumHeight(50)
        status_frame.setStyleSheet("""
            QFrame {
                background-color: #252526;
                border: 1px solid #3a3a3a;
                border-radius: 5px;
            }
        """)
        
        status_layout = QHBoxLayout(status_frame)
        status_layout.setContentsMargins(15, 5, 15, 5)
        
        # ì‹œê°„
        self.time_label = QLabel("ğŸ•’ --:--:--")
        self.time_label.setFont(QFont("Arial", 11))
        status_layout.addWidget(self.time_label)
        
        status_layout.addSpacing(30)
        
        # ì”ê³ 
        balance_label = QLabel("ğŸ’° ì”ê³ :")
        balance_label.setFont(QFont("Arial", 11))
        status_layout.addWidget(balance_label)
        
        self.balance_display = QLabel("$0.00")
        self.balance_display.setFont(QFont("Arial", 14, QFont.Bold))
        self.balance_display.setStyleSheet("color: #4ec9b0;")
        status_layout.addWidget(self.balance_display)
        
        status_layout.addSpacing(30)
        
        # BTC ê°€ê²©
        btc_label = QLabel("â‚¿ BTC:")
        btc_label.setFont(QFont("Arial", 11))
        status_layout.addWidget(btc_label)
        
        self.btc_price_display = QLabel("$0.00")
        self.btc_price_display.setFont(QFont("Arial", 14, QFont.Bold))
        self.btc_price_display.setStyleSheet("color: #f39c12;")
        status_layout.addWidget(self.btc_price_display)
        
        status_layout.addStretch()
        
        # ì—°ê²° ìƒíƒœ
        self.connection_indicator = QLabel("â—")
        self.connection_indicator.setFont(QFont("Arial", 16))
        self.connection_indicator.setStyleSheet("color: #888888;")
        status_layout.addWidget(self.connection_indicator)
        
        self.connection_label = QLabel("ì—°ê²° ì¤‘...")
        self.connection_label.setFont(QFont("Arial", 11))
        status_layout.addWidget(self.connection_label)
        
        layout.addWidget(status_frame)
    
    def create_backtest_tab(self):
        """ë°±í…ŒìŠ¤íŠ¸/ì•Œê³ ë¦¬ì¦˜ ê²€ì¦ íƒ­ ìƒì„±"""
        try:
            if BACKTEST_AVAILABLE:
                backtest_widget = create_backtest_tab()
                self.tab_widget.addTab(backtest_widget, "ğŸ§ª ì•Œê³ ë¦¬ì¦˜ ê²€ì¦")
                print("âœ… ë°±í…ŒìŠ¤íŠ¸ íƒ­ ì¶”ê°€ë¨")
            else:
                # ëŒ€ì²´ ìœ„ì ¯
                from PyQt5.QtWidgets import QWidget, QVBoxLayout, QLabel
                fallback = QWidget()
                layout = QVBoxLayout(fallback)
                
                info_label = QLabel("âš ï¸ ë°±í…ŒìŠ¤íŠ¸ ìœ„ì ¯ì„ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
                info_label.setStyleSheet("font-size: 14px; color: #f39c12;")
                layout.addWidget(info_label)
                
                instruction = QLabel(
                    "backtest_project í´ë”ë¥¼ í”„ë¡œì íŠ¸ ë£¨íŠ¸ì— ë³µì‚¬í•˜ì„¸ìš”:\n"
                    "D:\\Project\\CoinTrading\\backtest_project\\"
                )
                layout.addWidget(instruction)
                layout.addStretch()
                
                self.tab_widget.addTab(fallback, "ğŸ§ª ì•Œê³ ë¦¬ì¦˜ ê²€ì¦")
        except Exception as e:
            print(f"âŒ ë°±í…ŒìŠ¤íŠ¸ íƒ­ ìƒì„± ì‹¤íŒ¨: {e}")


    def create_dashboard_tab(self):
        """ëŒ€ì‹œë³´ë“œ íƒ­ - ì°¨íŠ¸ + í¬ì§€ì…˜ ì •ë³´"""
        dashboard_widget = QWidget()
        layout = QHBoxLayout(dashboard_widget)
        layout.setSpacing(10)
        
        # ì™¼ìª½: ì‹¤ì‹œê°„ ì°¨íŠ¸ (70%)
        chart_group = QGroupBox("ğŸ“ˆ BTC ì‹¤ì‹œê°„ ì°¨íŠ¸")
        chart_layout = QVBoxLayout(chart_group)
        
        if CHART_AVAILABLE:
            self.price_chart = PriceChartWidget()
            chart_layout.addWidget(self.price_chart)
        else:
            # ì°¨íŠ¸ ì—†ì„ ë•Œ ëŒ€ì²´ í‘œì‹œ
            chart_placeholder = QLabel("ì°¨íŠ¸ ìœ„ì ¯ ë¡œë“œ ì‹¤íŒ¨\n\nê°€ê²© ë°ì´í„°ëŠ” ìƒë‹¨ì—ì„œ í™•ì¸í•˜ì„¸ìš”")
            chart_placeholder.setAlignment(Qt.AlignCenter)
            chart_placeholder.setStyleSheet("color: #888888; font-size: 14px;")
            chart_layout.addWidget(chart_placeholder)
        
        # ì˜¤ë¥¸ìª½: ì •ë³´ íŒ¨ë„ (30%)
        info_panel = QWidget()
        info_layout = QVBoxLayout(info_panel)
        info_layout.setSpacing(10)
        
        # ê³„ì¢Œ ì •ë³´
        account_group = QGroupBox("ğŸ’° ê³„ì¢Œ ì •ë³´")
        account_layout = QGridLayout(account_group)
        
        account_layout.addWidget(QLabel("ì´ ìì‚°:"), 0, 0)
        self.total_equity_label = QLabel("$0.00")
        self.total_equity_label.setFont(QFont("Arial", 16, QFont.Bold))
        self.total_equity_label.setStyleSheet("color: #4ec9b0;")
        account_layout.addWidget(self.total_equity_label, 0, 1)
        
        account_layout.addWidget(QLabel("ì‚¬ìš© ê°€ëŠ¥:"), 1, 0)
        self.available_label = QLabel("$0.00")
        account_layout.addWidget(self.available_label, 1, 1)
        
        account_layout.addWidget(QLabel("ë¯¸ì‹¤í˜„ ì†ìµ:"), 2, 0)
        self.unrealized_pnl_label = QLabel("$0.00")
        account_layout.addWidget(self.unrealized_pnl_label, 2, 1)
        
        info_layout.addWidget(account_group)
        
        # í¬ì§€ì…˜ ì •ë³´
        position_group = QGroupBox("ğŸ“Š í˜„ì¬ í¬ì§€ì…˜")
        position_layout = QVBoxLayout(position_group)
        
        self.position_table = QTableWidget()
        self.position_table.setColumnCount(5)
        self.position_table.setHorizontalHeaderLabels([
            "ë°©í–¥", "ìˆ˜ëŸ‰", "ì§„ì…ê°€", "í˜„ì¬ê°€", "ì†ìµ"
        ])
        self.position_table.horizontalHeader().setSectionResizeMode(QHeaderView.Stretch)
        self.position_table.setMaximumHeight(150)
        self.position_table.setRowCount(0)
        position_layout.addWidget(self.position_table)
        
        # í¬ì§€ì…˜ ì—†ì„ ë•Œ ë©”ì‹œì§€
        self.no_position_label = QLabel("í¬ì§€ì…˜ ì—†ìŒ")
        self.no_position_label.setAlignment(Qt.AlignCenter)
        self.no_position_label.setStyleSheet("color: #888888;")
        position_layout.addWidget(self.no_position_label)
        
        info_layout.addWidget(position_group)
        
        # ì‹œì¥ ì •ë³´
        market_group = QGroupBox("ğŸ“‰ ì‹œì¥ ì •ë³´")
        market_layout = QGridLayout(market_group)
        
        market_layout.addWidget(QLabel("24h ê³ ê°€:"), 0, 0)
        self.high_24h_label = QLabel("$--")
        self.high_24h_label.setStyleSheet("color: #27ae60;")
        market_layout.addWidget(self.high_24h_label, 0, 1)
        
        market_layout.addWidget(QLabel("24h ì €ê°€:"), 1, 0)
        self.low_24h_label = QLabel("$--")
        self.low_24h_label.setStyleSheet("color: #e74c3c;")
        market_layout.addWidget(self.low_24h_label, 1, 1)
        
        market_layout.addWidget(QLabel("24h ë³€ë™:"), 2, 0)
        self.change_24h_label = QLabel("--%")
        market_layout.addWidget(self.change_24h_label, 2, 1)
        
        info_layout.addWidget(market_group)
        
        info_layout.addStretch()
        
        # ë ˆì´ì•„ì›ƒ ë¹„ìœ¨ ì„¤ì •
        layout.addWidget(chart_group, 7)
        layout.addWidget(info_panel, 3)
        
        self.tab_widget.addTab(dashboard_widget, "ğŸ“Š ëŒ€ì‹œë³´ë“œ")
    
    def create_auto_trading_tab(self):
        """ìë™ë§¤ë§¤ íƒ­"""
        if AUTO_TRADING_AVAILABLE:
            self.auto_trading_widget = AutoTradingWidget()
            self.tab_widget.addTab(self.auto_trading_widget, "ğŸ¤– ìë™ë§¤ë§¤")
        else:
            # ëŒ€ì²´ ìœ„ì ¯
            placeholder = QWidget()
            layout = QVBoxLayout(placeholder)
            label = QLabel("ìë™ë§¤ë§¤ ìœ„ì ¯ì„ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\ngui/auto_trading_widget.py íŒŒì¼ì„ í™•ì¸í•˜ì„¸ìš”.")
            label.setAlignment(Qt.AlignCenter)
            label.setStyleSheet("color: #888888; font-size: 14px;")
            layout.addWidget(label)
            self.auto_trading_widget = None
            self.tab_widget.addTab(placeholder, "ğŸ¤– ìë™ë§¤ë§¤")
    
    def setup_data_thread(self):
        """ë°ì´í„° ìŠ¤ë ˆë“œ ì„¤ì •"""
        self.data_thread = None
        
        if DATA_THREAD_AVAILABLE:
            try:
                # AccountManager ìƒì„±
                account_manager = None
                if ACCOUNT_MANAGER_AVAILABLE:
                    account_manager = AccountManager(verbose=False)
                
                self.data_thread = TradingDataThread(account_manager)
                
                # BTCë§Œ ê°ì‹œí•˜ë„ë¡ ì„¤ì •
                self.data_thread.symbols = ['BTC-USDT-SWAP']
                
                # ì‹œê·¸ë„ ì—°ê²°
                self.data_thread.price_updated.connect(self.on_price_updated)
                self.data_thread.balance_updated.connect(self.on_balance_updated)
                self.data_thread.positions_updated.connect(self.on_positions_updated)
                self.data_thread.connection_changed.connect(self.on_connection_changed)
                self.data_thread.signal_lost.connect(self.on_signal_lost)
                self.data_thread.error_occurred.connect(self.on_error)
                
                # ìŠ¤ë ˆë“œ ì‹œì‘
                self.data_thread.start()
                
            except Exception as e:
                print(f"âš ï¸ ë°ì´í„° ìŠ¤ë ˆë“œ ì´ˆê¸°í™” ì‹¤íŒ¨: {e}")
    
    def setup_timers(self):
        """íƒ€ì´ë¨¸ ì„¤ì •"""
        # ì‹œê³„ íƒ€ì´ë¨¸
        self.clock_timer = QTimer()
        self.clock_timer.timeout.connect(self.update_clock)
        self.clock_timer.start(1000)
    
    def update_clock(self):
        """ì‹œê³„ ì—…ë°ì´íŠ¸"""
        now = datetime.now().strftime("%H:%M:%S")
        self.time_label.setText(f"ğŸ•’ {now}")
    
    # =========================================================
    # ë°ì´í„° ì—…ë°ì´íŠ¸ í•¸ë“¤ëŸ¬
    # =========================================================
    
    def on_price_updated(self, symbol: str, price: float, info: dict):
        """ê°€ê²© ì—…ë°ì´íŠ¸"""
        if symbol != 'BTC-USDT-SWAP':
            return  # BTCë§Œ ì²˜ë¦¬
        
        self.current_btc_price = price
        self.btc_price_display.setText(f"${price:,.2f}")
        
        # ì‹œì¥ ì •ë³´ ì—…ë°ì´íŠ¸
        high_24h = info.get('high24h', 0)
        low_24h = info.get('low24h', 0)
        
        if high_24h > 0:
            self.high_24h_label.setText(f"${high_24h:,.2f}")
        if low_24h > 0:
            self.low_24h_label.setText(f"${low_24h:,.2f}")
        
        # ë³€ë™ë¥  ê³„ì‚°
        if high_24h > 0 and low_24h > 0:
            change_pct = ((price - low_24h) / low_24h) * 100
            color = "#27ae60" if change_pct >= 0 else "#e74c3c"
            self.change_24h_label.setText(f"{change_pct:+.2f}%")
            self.change_24h_label.setStyleSheet(f"color: {color};")
        
        # ì°¨íŠ¸ ì—…ë°ì´íŠ¸
        if CHART_AVAILABLE and hasattr(self, 'price_chart'):
            self.price_chart.update_price(symbol, price, info)
        
        # ìë™ë§¤ë§¤ ìœ„ì ¯ì— ê°€ê²© ì „ë‹¬
        if self.auto_trading_widget and hasattr(self.auto_trading_widget, 'btc_price_label'):
            self.auto_trading_widget.btc_price_label.setText(f"${price:,.2f}")
    
    def on_balance_updated(self, balance_data: dict):
        """ì”ê³  ì—…ë°ì´íŠ¸"""
        total_equity = balance_data.get('total_equity', 0)
        available = balance_data.get('available_balance', 0)
        
        self.current_balance = available
        
        # ìƒë‹¨ ë°” ì—…ë°ì´íŠ¸
        self.balance_display.setText(f"${available:,.2f}")
        
        # ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸
        self.total_equity_label.setText(f"${total_equity:,.2f}")
        self.available_label.setText(f"${available:,.2f}")
        
        # ìë™ë§¤ë§¤ ìœ„ì ¯ì— ì”ê³  ì „ë‹¬
        if self.auto_trading_widget and hasattr(self.auto_trading_widget, 'on_balance_updated'):
            self.auto_trading_widget.on_balance_updated(available)
    
    def on_positions_updated(self, positions: list):
        """í¬ì§€ì…˜ ì—…ë°ì´íŠ¸"""
        self.positions = positions
        
        # í…Œì´ë¸” ì—…ë°ì´íŠ¸
        self.position_table.setRowCount(0)
        
        # BTC í¬ì§€ì…˜ë§Œ í•„í„°ë§
        btc_positions = [p for p in positions if 'BTC' in p.get('instId', '')]
        
        total_pnl = 0
        
        if btc_positions:
            self.no_position_label.hide()
            self.position_table.show()
            
            for pos in btc_positions:
                row = self.position_table.rowCount()
                self.position_table.insertRow(row)
                
                # ë°©í–¥
                pos_side = pos.get('posSide', 'net')
                pos_size = float(pos.get('pos', 0))
                if pos_side == 'net':
                    direction = "ë¡±" if pos_size > 0 else "ìˆ"
                else:
                    direction = "ë¡±" if pos_side == 'long' else "ìˆ"
                
                direction_item = QTableWidgetItem(direction)
                direction_item.setForeground(QColor("#27ae60" if "ë¡±" in direction else "#e74c3c"))
                self.position_table.setItem(row, 0, direction_item)
                
                # ìˆ˜ëŸ‰
                self.position_table.setItem(row, 1, QTableWidgetItem(f"{abs(pos_size):.4f}"))
                
                # ì§„ì…ê°€
                avg_price = float(pos.get('avgPx', 0))
                self.position_table.setItem(row, 2, QTableWidgetItem(f"${avg_price:,.2f}"))
                
                # í˜„ì¬ê°€
                self.position_table.setItem(row, 3, QTableWidgetItem(f"${self.current_btc_price:,.2f}"))
                
                # ì†ìµ
                upl = float(pos.get('upl', 0))
                total_pnl += upl
                pnl_item = QTableWidgetItem(f"${upl:+,.2f}")
                pnl_item.setForeground(QColor("#27ae60" if upl >= 0 else "#e74c3c"))
                self.position_table.setItem(row, 4, pnl_item)
        else:
            self.position_table.hide()
            self.no_position_label.show()
        
        # ë¯¸ì‹¤í˜„ ì†ìµ ì—…ë°ì´íŠ¸
        pnl_color = "#27ae60" if total_pnl >= 0 else "#e74c3c"
        self.unrealized_pnl_label.setText(f"${total_pnl:+,.2f}")
        self.unrealized_pnl_label.setStyleSheet(f"color: {pnl_color};")
    
    def on_connection_changed(self, connected: bool):
        """ì—°ê²° ìƒíƒœ ë³€ê²½"""
        self.is_connected = connected
        
        if connected:
            self.connection_indicator.setStyleSheet("color: #27ae60;")
            self.connection_label.setText("ì—°ê²°ë¨")
            self.status_bar.showMessage("API ì—°ê²° ì™„ë£Œ")
        else:
            self.connection_indicator.setStyleSheet("color: #e74c3c;")
            self.connection_label.setText("ì—°ê²° ëŠê¹€")
            self.status_bar.showMessage("API ì—°ê²° ì‹¤íŒ¨")
    
    def on_signal_lost(self):
        """Signal Lost"""
        self.connection_indicator.setStyleSheet("color: #e74c3c;")
        self.connection_label.setText("SIGNAL LOST")
        self.status_bar.showMessage("âš ï¸ API ì—°ê²° ëŠê¹€ - ë°ì´í„° ê°±ì‹  ì¤‘ë‹¨")
        
        QMessageBox.warning(
            self,
            "ì—°ê²° ê²½ê³ ",
            "API ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤.\n\nìë™ìœ¼ë¡œ ì¬ì—°ê²°ì„ ì‹œë„í•©ë‹ˆë‹¤."
        )
    
    def on_error(self, error_msg: str):
        """ì—ëŸ¬ ë°œìƒ"""
        self.status_bar.showMessage(f"ì˜¤ë¥˜: {error_msg}")
    
    # =========================================================
    # ì¢…ë£Œ ì²˜ë¦¬
    # =========================================================
    
    def closeEvent(self, event):
        """ìœˆë„ìš° ì¢…ë£Œ"""
        # ìë™ë§¤ë§¤ ì¤‘ì§€ í™•ì¸
        if self.auto_trading_widget and hasattr(self.auto_trading_widget, 'is_running'):
            if self.auto_trading_widget.is_running:
                reply = QMessageBox.question(
                    self,
                    "ì¢…ë£Œ í™•ì¸",
                    "ìë™ë§¤ë§¤ê°€ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤.\n\nì •ë§ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?",
                    QMessageBox.Yes | QMessageBox.No,
                    QMessageBox.No
                )
                if reply == QMessageBox.No:
                    event.ignore()
                    return
                
                # ìë™ë§¤ë§¤ ì¤‘ì§€
                self.auto_trading_widget.stop_trading()
        
        # ë°ì´í„° ìŠ¤ë ˆë“œ ì¤‘ì§€
        if self.data_thread:
            self.data_thread.stop()
            self.data_thread.wait(3000)
        
        event.accept()
        print("ğŸ”š í”„ë¡œê·¸ë¨ ì¢…ë£Œ")


def run_app():
    """ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰"""
    from PyQt5.QtWidgets import QApplication
    
    app = QApplication(sys.argv)
    app.setStyle('Fusion')
    
    window = TradingMainWindow()
    window.show()
    
    sys.exit(app.exec_())


if __name__ == "__main__":
    run_app()